#!/bin/bash

# Check if Brakeman is installed
if ! [ -x "$(command -v brakeman)" ]; then
    echo 'Error: Brakeman is not installed.' >&2
    exit 1
fi

# Run Brakeman
output=$(brakeman -f json)

# Parse the output and post results back to Buildkite
warnings=$(echo $output | jq '.warnings')
errors=$(echo $output | jq '.errors')

# Post results back to Buildkite
curl -X POST -H "Authorization: Bearer $BUILDKITE_API_TOKEN" \
    -d "{
    \"warnings\": $warnings,
    \"errors\": $errors
  }" \
    "https://api.buildkite.com/v2/organizations/$BUILDKITE_ORGANIZATION_SLUG/pipelines/$BUILDKITE_PIPELINE_SLUG/builds/$BUILDKITE_BUILD_NUMBER/annotations"
